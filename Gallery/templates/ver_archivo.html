{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ archivo.nombre }}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Product+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
    
    <style>
        /* Ajustes específicos para esta vista de pantalla completa */
        body {
            background-color: #000; /* Fondo negro como el modal */
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- 1. BARRA SUPERIOR (Idéntica al Modal del Index) --- */
        .viewer-top-bar {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            padding: 20px; 
            display: flex; 
            justify-content: space-between; 
            z-index: 2002;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
        }

        /* --- 2. FLECHAS (Idénticas al Index) --- */
        .nav-arrow {
            position: absolute;
            background: none;
            border: none;
            color: white;
            font-size: 3rem;
            cursor: pointer;
            z-index: 2002;
            opacity: 0.5;
            padding: 20px;
            transition: opacity 0.2s, transform 0.2s;
        }
        .nav-arrow:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        .nav-arrow.left { left: 20px; }
        .nav-arrow.right { right: 20px; }

        /* --- 3. CONTENEDOR MEDIA --- */
        #mediaContainer {
            width: 100%; 
            height: 85%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            position: relative;
        }

        /* Capas para efecto Blur-Up sin XHR complejo */
        .media-layer {
            max-width: 100%;
            max-height: 100vh;
            object-fit: contain;
            position: absolute;
            transition: opacity 0.3s ease;
        }

        .blur-layer {
            filter: blur(10px);
            z-index: 1;
            opacity: 1;
        }

        .hd-layer {
            z-index: 2;
            opacity: 0; /* Se vuelve 1 al cargar */
        }
        
        /* Dropdown menú específico */
        .gp-dropdown-menu {
            top: 100%;
            right: 0;
            margin-top: 10px;
        }
        
        /* Modal de confirmación propio de esta vista */
        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 3000;
            display: none; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <form id="csrf-form">
        {% csrf_token %}
    </form>

    <div class="viewer-top-bar">
        <a href="{% url 'index' %}" class="btn btn-link text-white fs-4">
            <i class="fas fa-arrow-left"></i>
        </a>
        
        <div class="d-flex gap-3 align-items-center position-relative">
            <button id="btnDelete" class="btn btn-link text-white fs-5" title="Eliminar">
                <i class="fas fa-trash-alt"></i>
            </button>
            
            <button id="btnMoreOptions" class="btn btn-link text-white fs-5" title="Más opciones">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        
            <div id="modalDropdown" class="gp-dropdown-menu d-none">
                <button class="gp-dropdown-item" id="btnAddToAlbum">
                    <i class="far fa-folder-open"></i> 
                    <span>Añadir a un álbum</span>
                </button>
                <a href="#" class="gp-dropdown-item" id="btnDownload">
                    <i class="fas fa-download"></i>
                    <span>Descargar</span>
                </a>
            </div>
        </div>
    </div>

    {% if prev_id %}
        <a href="{% url 'ver_detalle_global' prev_id %}" class="nav-arrow left" title="Anterior">❮</a>
    {% endif %}

    {% if next_id %}
        <a href="{% url 'ver_detalle_global' next_id %}" class="nav-arrow right" title="Siguiente">❯</a>
    {% endif %}

    <div id="mediaContainer">
        
        <img src="{{ archivo.thumbnail_base64|default:archivo.miniatura_url }}" 
             class="media-layer blur-layer" 
             id="blurImg"
             alt="">

        {% if archivo.tipo == 'video' %}
            <video 
                id="hdMedia"
                class="media-layer hd-layer" 
                controls autoplay 
                style="opacity: 0;">
            </video>
        {% else %}
            <img 
                id="hdMedia"
                class="media-layer hd-layer" 
                alt="{{ archivo.nombre }}">
        {% endif %}
    </div>

    <div class="custom-modal-overlay" id="deleteConfirmModal">
        <div class="modal-dialog modal-sm" style="pointer-events: auto;">
            <div class="modal-content" style="background-color: #202124; border: 1px solid #5f6368; color: #e8eaed; border-radius: 12px; width: 300px;">
                <div class="modal-body text-center p-4">
                    <div class="mb-3">
                        <i class="fas fa-trash-alt fa-3x text-danger"></i>
                    </div>
                    <h5 class="mb-2 fw-bold">¿Eliminar archivo?</h5>
                    <p class="small text-secondary mb-4">Esta acción no se puede deshacer.</p>
                    
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="closeDeleteModal()" style="border-color: #5f6368; color: #e8eaed;">
                            Cancelar
                        </button>
                        <button id="btnConfirmDeleteAction" class="btn btn-danger rounded-pill px-4">
                            Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- 1. LÓGICA DE CARGA IDÉNTICA AL INDEX (Para Cache Hit) ---
    const RAW_URL = "{{ archivo.archivo.url }}";
    const IS_VIDEO = "{{ archivo.tipo }}" === "video";
    const SCREEN_WIDTH = window.innerWidth;

    const blurImg = document.getElementById('blurImg');
    const hdMedia = document.getElementById('hdMedia');

    function getOptimizedUrl(fullUrl, isVideo) {
        const separator = fullUrl.includes('?') ? '&' : '?';
        if (isVideo) return `${fullUrl}${separator}tr=orig-true`;
        
        // El mismo redondeo que en index.js para que la URL sea string-exacta
        const roundedWidth = Math.ceil(SCREEN_WIDTH / 200) * 200; 
        return `${fullUrl}${separator}tr=w-${roundedWidth},f-auto,q-auto`;
    }

    // Iniciar carga
    const finalUrl = getOptimizedUrl(RAW_URL, IS_VIDEO);
    hdMedia.src = finalUrl;

    // Cuando cargue, mostrar HD y ocultar Blur
    if (IS_VIDEO) {
        hdMedia.oncanplay = () => {
            hdMedia.style.opacity = '1';
            blurImg.style.opacity = '0';
        };
    } else {
        hdMedia.onload = () => {
            hdMedia.style.opacity = '1';
            blurImg.style.opacity = '0';
        };
    }

    // --- 2. FUNCIONALIDAD DE MENÚS ---
    const btnMoreOptions = document.getElementById('btnMoreOptions');
    const modalDropdown = document.getElementById('modalDropdown');
    const btnDownload = document.getElementById('btnDownload');
    const btnAddToAlbum = document.getElementById('btnAddToAlbum');

    // Toggle Menú
    btnMoreOptions.addEventListener('click', (e) => {
        e.stopPropagation();
        modalDropdown.classList.toggle('d-none');
    });

    // Cerrar menú al hacer clic fuera
    document.addEventListener('click', (e) => {
        if (!modalDropdown.classList.contains('d-none') && 
            !modalDropdown.contains(e.target) && 
            !btnMoreOptions.contains(e.target)) {
            modalDropdown.classList.add('d-none');
        }
    });

    btnAddToAlbum.addEventListener('click', () => {
        alert('Funcionalidad "Añadir a álbum" próximamente.');
        modalDropdown.classList.add('d-none');
    });

    // --- 3. LÓGICA DE DESCARGA FORZADA (Restaurada) ---
    btnDownload.addEventListener('click', (e) => {
        e.preventDefault();
        modalDropdown.classList.add('d-none');
        
        // Nombre de archivo limpio
        const filename = decodeURIComponent(RAW_URL.split('/').pop().split('?')[0]);
        
        // Usamos fetch para forzar la descarga como Blob (evita abrir en pestaña)
        fetch(RAW_URL)
            .then(response => response.blob())
            .then(blob => {
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(blobUrl);
                document.body.removeChild(a);
            })
            .catch(() => {
                // Fallback si falla el fetch (ej: CORS estricto)
                window.open(RAW_URL, '_blank');
            });
    });

    // --- 4. LÓGICA DE BORRADO ---
    const deleteModal = document.getElementById('deleteConfirmModal');
    const btnDelete = document.getElementById('btnDelete');
    const btnConfirmDelete = document.getElementById('btnConfirmDeleteAction');

    btnDelete.addEventListener('click', () => {
        modalDropdown.classList.add('d-none');
        deleteModal.style.display = 'flex'; // Mostrar modal
    });

    function closeDeleteModal() {
        deleteModal.style.display = 'none';
    }

    btnConfirmDelete.addEventListener('click', () => {
        // UI Feedback
        const originalText = btnConfirmDelete.innerHTML;
        btnConfirmDelete.disabled = true;
        btnConfirmDelete.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Borrando...';

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch("{% url 'eliminar_archivo' %}", {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/x-www-form-urlencoded', 
                'X-CSRFToken': csrfToken 
            },
            body: `archivo_id={{ archivo.id }}`
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                window.location.href = "{% url 'index' %}";
            } else {
                alert('Error: ' + data.error);
                btnConfirmDelete.disabled = false;
                btnConfirmDelete.innerHTML = originalText;
                closeDeleteModal();
            }
        })
        .catch(err => {
            alert('Error de red');
            btnConfirmDelete.disabled = false;
            btnConfirmDelete.innerHTML = originalText;
            closeDeleteModal();
        });
    });

    // --- 5. TECLADO ---
    document.addEventListener('keydown', (e) => {
        // Si el modal de borrado está abierto
        if (deleteModal.style.display === 'flex') {
            if (e.key === 'Escape') closeDeleteModal();
            if (e.key === 'Enter') btnConfirmDelete.click();
            return;
        }

        switch(e.key) {
            case 'ArrowLeft': 
                {% if prev_id %} document.querySelector('.nav-arrow.left').click(); {% endif %} 
                break;
            case 'ArrowRight': 
                {% if next_id %} document.querySelector('.nav-arrow.right').click(); {% endif %} 
                break;
            case 'Escape': 
                window.location.href = "{% url 'index' %}"; 
                break;
            case 'Delete': 
                btnDelete.click(); 
                break;
        }
    });
</script>

</body>
</html>