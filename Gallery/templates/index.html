{% load static %}
{% load l10n %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ title }}</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Product+Sans:wght@400;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'index.css' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'icon.svg' %}">
</head>
<body>

<form id="csrf-form">
    {% csrf_token %}
</form>

<div class="app-container">

    <nav class="sidebar">
        <div class="brand-area">
            <i class="fas fa-camera-retro" style="background: -webkit-linear-gradient(45deg, #4285F4, #DB4437, #F4B400, #0F9D58); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 28px;"></i>
            <span style="font-family: 'Product Sans', sans-serif; font-weight: normal; color: #e8eaed; letter-spacing: -0.5px;">MyMediaHub</span>
        </div>

        <div class="px-3 mb-4">
             <a href="/admin/Galeria/mediafile/add/" class="btn w-100 text-start rounded-pill py-2 shadow-sm d-flex align-items-center justify-content-center" 
                style="background-color: #e8eaed; color: #202124; border: none; font-weight: 500;">
                <i class="fas fa-plus me-2" style="color: #4285F4;"></i> Subir Archivo
             </a>
        </div>

        <a href="{% url 'index' %}" class="nav-item {% if active_tab == 'general' %}active{% endif %}">
            <i class="far fa-image"></i> Principal
        </a>
        
        <div style="height: 1px; background: var(--gp-border); margin: 10px 24px;"></div>

        <small class="px-4 mb-2 fw-bold" style="font-size: 11px; color: var(--gp-text-secondary); letter-spacing: 0.8px;">BIBLIOTECA</small>
        
        <a href="#" class="nav-item">
            <i class="far fa-star"></i> Favoritos
        </a>
        <a href="{% url 'lista_albumes' %}" class="nav-item {% if active_tab == 'albumes' %}active{% endif %}">
            <i class="far fa-folder"></i> Álbumes
        </a>
        <a href="#" class="nav-item">
            <i class="far fa-trash-alt"></i> Papelera
        </a>
        
        <div style="height: 1px; background: var(--gp-border); margin: 10px 24px;"></div>

        <small class="px-4 mb-2 fw-bold" style="font-size: 11px; color: var(--gp-text-secondary); letter-spacing: 0.8px;">UTILIDADES</small>
        
        <a href="{% url 'sincronizar' %}" class="nav-item">
            <i class="fas fa-sync-alt"></i> Sincronizar Nube
        </a>

        <div class="storage-widget">
             <div class="storage-info">
                 <span>Almacenamiento</span>
                 <span class="storage-numbers">{{ storage.used_str }} de {{ storage.limit_str }}</span>
             </div>
             
            <div class="storage-bar-bg" style="display: flex; background-color: #3c4043; border-radius: 10px; overflow: hidden; height: 6px;">
                <div style="width: {{ storage.percent_image|unlocalize }}%; background-color: #EA4335; height: 100%; transition: width 1s;" 
                     title="Imágenes"></div>
                
                <div style="width: {{ storage.percent_video|unlocalize }}%; background-color: #8ab4f8; height: 100%; transition: width 1s;" 
                     title="Videos"></div>
             </div>

             <div class="d-flex justify-content-between mt-2" style="font-size: 11px; color: #9aa0a6;">
                <span>{{ storage.file_count }} archivos</span>
                <span>{{ storage.percent|floatformat:1 }}% ocupado</span>
             </div>
        </div>
    </nav>

    <main class="main-content">
        
        {% if messages %}
            <div class="position-fixed top-0 end-0 p-3" style="z-index: 2000">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-lg" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <header class="top-bar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Buscar en tu galería...">
            </div>
            <div class="ms-3 rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-size: 14px;">A</div>
        </header>

        {% regroup media_files by creado_en|date:"F Y" as media_by_month %}

        {% for month in media_by_month %}
            <div class="timeline-group fade-in-up">
                
                <div class="date-header">
                    <span>{{ month.grouper|capfirst }}</span>
                </div>

                <div class="photo-grid">
                    {% for media in month.list %}
                        <div class="photo-item open-media" data-full-url="{{ media.archivo.url }}" data-id="{{ media.id }}">
                            
                            <img src="{{ media.miniatura_url }}" alt="Media" loading="lazy">
                            
                            {% if media.is_video %}
                                <div class="position-absolute top-0 end-0 m-2 text-white" style="text-shadow: 0 1px 2px black;">
                                    <i class="fas fa-play-circle fs-5"></i>
                                </div>
                            {% endif %}
                            
                            {% if media.is_gif %}
                                <div class="position-absolute top-0 end-0 m-2">
                                    <span class="badge bg-dark border border-secondary" style="font-size: 9px;">GIF</span>
                                </div>
                            {% endif %}

                        </div>
                    {% endfor %}
                </div>
            </div>
        {% empty %}
            <div class="empty-state">
                <i class="fas fa-cloud-upload-alt mb-3" style="font-size: 64px; color: #5f6368;"></i>
                <h4 style="color: #e8eaed;">Tu galería está vacía</h4>
                <p style="color: #9aa0a6;">Sube fotos o dale a "Sincronizar" si ya tienes archivos en ImageKit.</p>
                <a href="/admin/Galeria/mediafile/add/" class="btn btn-primary rounded-pill px-4 mt-3">Subir ahora</a>
            </div>
        {% endfor %}

    </main>
</div>

<div id="modal" class="d-none" tabindex="-1" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.96); z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center; outline:none;">
    
    <div style="position: absolute; top: 0; left: 0; width: 100%; padding: 20px; display: flex; justify-content: space-between; z-index: 2002;">
        <button id="closeModal" class="btn btn-link text-white fs-4"><i class="fas fa-arrow-left"></i></button>
        <div class="d-flex gap-3">
            <button id="btnDelete" class="btn btn-link text-white fs-5" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
        </div>
    </div>

    <button id="prevBtn" class="nav-arrow left" style="position:absolute; left:20px; background:none; border:none; color:white; font-size:3rem; cursor:pointer; z-index:2002; opacity:0.5;">❮</button>
    <button id="nextBtn" class="nav-arrow right" style="position:absolute; right:20px; background:none; border:none; color:white; font-size:3rem; cursor:pointer; z-index:2002; opacity:0.5;">❯</button>

    <div id="modalContent" style="width:100%; height:85%; display: flex; align-items: center; justify-content: center;"></div>

    <div id="modalLoader" class="modal-loader-container d-none">
        <div class="modal-progress-bg">
            <div id="modalProgressBar" class="modal-progress-bar"></div>
        </div>
        <div id="modalProgressText" class="modal-progress-text">Cargando... 0%</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    const mediaItems = Array.from(document.querySelectorAll('.open-media')); 
    
    // Elementos de la barra
    const modalLoader = document.getElementById('modalLoader');
    const modalProgressBar = document.getElementById('modalProgressBar');
    const modalProgressText = document.getElementById('modalProgressText');
    
    let currentIndex = -1; 
    let currentXhr = null; // Referencia para cancelar descargas

    // 1. URL OPTIMIZADA
    function getOptimizedUrl(fullUrl, isVideo = false) {
        if (isVideo) {
            const separator = fullUrl.includes('?') ? '&' : '?';
            return `${fullUrl}${separator}tr=orig-true`;
        }
        const width = window.innerWidth;
        const roundedWidth = Math.ceil(width / 200) * 200; 
        const transformations = `tr=w-${roundedWidth}`; 
        const separator = fullUrl.includes('?') ? '&' : '?';
        return `${fullUrl}${separator}${transformations}`;
    }

    // 2. PRECARGA (Solo imágenes siguientes)
    function preloadNextFiles(startIndex) {
        const prefetchCount = 2; 
        for (let i = 1; i <= prefetchCount; i++) {
            const nextIndex = startIndex + i;
            if (nextIndex >= mediaItems.length) break;

            const item = mediaItems[nextIndex];
            const rawUrl = item.getAttribute('data-full-url');
            if (item.querySelector('.fa-play-circle') === null) { 
                const img = new Image();
                img.src = getOptimizedUrl(rawUrl, false);
            }
        }
    }

    // 3. CARGA CON XHR (BARRA DE PROGRESO)
    function loadImageWithXHR(url) {
        return new Promise((resolve, reject) => {
            if (currentXhr) { currentXhr.abort(); } // Cancelar anterior

            const xhr = new XMLHttpRequest();
            currentXhr = xhr;

            xhr.open('GET', url, true);
            xhr.responseType = 'blob';

            xhr.onprogress = (event) => {
                if (event.lengthComputable) {
                    // Si el servidor nos dice el tamaño total
                    const percentComplete = (event.loaded / event.total) * 100;
                    updateProgressBar(percentComplete, `Cargando... ${Math.round(percentComplete)}%`);
                } else {
                    // Si el servidor NO dice el tamaño (Chunked encoding)
                    // Ponemos la barra al 100% visualmente pero con texto de espera
                    updateProgressBar(100, "Procesando imagen...");
                }
            };

            xhr.onload = () => {
                if (xhr.status === 200) {
                    updateProgressBar(100, "Completado");
                    resolve(window.URL.createObjectURL(xhr.response));
                } else {
                    reject(new Error(`Error HTTP: ${xhr.status}`));
                }
                currentXhr = null;
            };

            xhr.onerror = () => {
                // Esto suele saltar por CORS (Cross-Origin Resource Sharing)
                reject(new Error('Error de Red / CORS'));
                currentXhr = null;
            };
            
            xhr.send();
        });
    }

    function updateProgressBar(percent, text) {
        modalLoader.classList.remove('d-none');
        modalProgressBar.style.width = percent + '%';
        if (text) modalProgressText.innerText = text;
        
        // Si llega a 100, ocultar tras un breve delay (pero no si es "Procesando...")
        if (percent >= 100 && text === "Completado") {
            setTimeout(() => {
                modalLoader.classList.add('d-none');
                modalProgressBar.style.width = '0%'; // Reset visual
            }, 300);
        }
    }

    // 4. ABRIR MODAL
    async function openModal(index) {
        if (index < 0 || index >= mediaItems.length) return;
        preloadNextFiles(index);

        currentIndex = index;
        const item = mediaItems[index];
        const rawUrl = item.getAttribute('data-full-url');
        const isVideo = item.querySelector('.fa-play-circle') !== null;
        
        modalContent.innerHTML = ''; 
        
        // Limpiar estado de carga
        if (currentXhr) { currentXhr.abort(); }
        modalLoader.classList.add('d-none');

        modal.classList.remove('d-none'); 
        document.body.style.overflow = 'hidden'; 
        modal.focus();

        const finalUrl = getOptimizedUrl(rawUrl, isVideo);

        if (isVideo) {
            // VIDEO: Carga nativa (streaming)
            const video = document.createElement('video');
            video.src = finalUrl;
            video.controls = true;
            video.autoplay = true;
            video.style.maxWidth = '100%';
            video.style.maxHeight = '90vh';
            modalContent.appendChild(video);
        } else {
            // IMAGEN: Intentamos carga con barra, si falla, carga normal
            try {
                // Placeholder borroso (Miniatura inmediata)
                const thumbUrl = item.querySelector('img').src;
                const imgPlaceholder = document.createElement('img');
                imgPlaceholder.src = thumbUrl;
                Object.assign(imgPlaceholder.style, {
                    maxWidth: '100%', maxHeight: '90vh', objectFit: 'contain',
                    filter: 'blur(10px)', position: 'absolute', zIndex: '1', opacity: '0.6'
                });
                modalContent.appendChild(imgPlaceholder);
                
                // 2. Mostrar explícitamente la barra al 0% antes de empezar
                updateProgressBar(0, "Iniciando descarga...");

                // Intentamos descargar el Blob (puede fallar por CORS)
                const blobUrl = await loadImageWithXHR(finalUrl);

                // ÉXITO: Creamos imagen desde el Blob local
                createFinalImage(blobUrl, imgPlaceholder, true);

            } catch (e) {
                console.warn("Fallo carga con barra (posible CORS), usando carga estándar.", e);
                // FALLBACK: Carga estándar sin XHR
                // Ocultamos barra de error
                modalLoader.classList.add('d-none');
                // Cargamos la imagen directamente de la URL
                createFinalImage(finalUrl, modalContent.querySelector('img'), false);
            }
        }
    }

    // Helper para insertar la imagen final
    function createFinalImage(source, placeholder, isBlob) {
        const img = document.createElement('img');
        img.src = source;
        Object.assign(img.style, {
            maxWidth: '100%', maxHeight: '90vh', objectFit: 'contain',
            zIndex: '2', position: 'relative', opacity: '0', transition: 'opacity 0.3s ease'
        });
        
        img.onload = () => {
            img.style.opacity = '1';
            // Eliminar placeholder
            if (placeholder) setTimeout(() => placeholder.remove(), 300);
            // Si era un blob, liberar memoria
            if (isBlob) window.URL.revokeObjectURL(source);
        };
        
        modalContent.appendChild(img);
    }

    function closeModal() {
        if (currentXhr) { currentXhr.abort(); currentXhr = null; }
        modal.classList.add('d-none');
        modalContent.innerHTML = '';
        modalLoader.classList.add('d-none'); 
        document.body.style.overflow = 'auto';
        const video = modalContent.querySelector('video');
        if (video) video.pause();
    }

    // --- EVENTOS ---
    mediaItems.forEach((item, index) => {
        item.addEventListener('click', () => openModal(index));
    });

    function nextImage() { openModal(currentIndex + 1); }
    function prevImage() { openModal(currentIndex - 1); }

    document.getElementById('nextBtn').addEventListener('click', (e) => { e.stopPropagation(); nextImage(); });
    document.getElementById('prevBtn').addEventListener('click', (e) => { e.stopPropagation(); prevImage(); });
    document.getElementById('closeModal').addEventListener('click', closeModal);

    document.addEventListener('keydown', (e) => {
        if (modal.classList.contains('d-none')) return;
        switch(e.key) {
            case 'ArrowRight': nextImage(); break;
            case 'ArrowLeft': prevImage(); break;
            case 'Escape': closeModal(); break;
            case 'Delete': deleteCurrentFile(); break;
        }
    });

    // Lógica de borrado (sin cambios)
    document.getElementById('btnDelete').addEventListener('click', deleteCurrentFile);
    function deleteCurrentFile() {
        if (!confirm('¿Eliminar archivo permanentemente?')) return;
        const currentItem = mediaItems[currentIndex];
        const fileId = currentItem.getAttribute('data-id'); 
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch("{% url 'eliminar_archivo' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrfToken },
            body: `archivo_id=${fileId}`
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                closeModal();
                currentItem.style.transform = "scale(0)";
                setTimeout(() => { currentItem.remove(); window.location.reload(); }, 300);
            } else { alert('Error: ' + data.error); }
        });
    }

    // --- SERVICE WORKER Y CULLING ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js').catch(console.error));
    }

    document.addEventListener("DOMContentLoaded", function() {
        const observerOptions = { root: null, rootMargin: '600px 0px', threshold: 0.01 };
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const img = entry.target;
                if (entry.isIntersecting) {
                    if (img.dataset.src) img.src = img.dataset.src;
                } else {
                    if (img.src && img.src !== window.location.href) {
                        img.dataset.src = img.src;
                        img.removeAttribute('src');
                    }
                }
            });
        }, observerOptions);

        document.querySelectorAll('.photo-item img').forEach(img => {
            if(img.src) img.dataset.src = img.src; 
            imageObserver.observe(img);
        });
    });
</script>

<style>
    .nav-arrow:hover { opacity: 1 !important; transform: scale(1.1); transition: 0.2s; }
</style>

</body>
</html>